\lhead{\emph{Conclusion}}
\chapter{Conclusion}\label{ch:conclusion}



\section{Summary of the Thesis}
This thesis started with reproducing the works of Ref.~\cite{bea}. While doing so we face problems in terms of slow current response in the compensation coils. We have done different experiments with different parameters for understanding the problem and figure out the solution. We have tried to make the system faster by increasing loop sampling frequency. To avoid high frequency noise we have built a $\mathbf{4^{th}}$ order low pass butterworth filter with 10 Hz corner frequency. The filter is one of the many achievements of this thesis. The filter is described in Section~\ref{sec:filter}. The effect  of the filter on increasing loop sampling frequency and noise reduction are discussed in Section~\ref{sec:freq}. We have used PI control algorithm to generate new current (Eq.~(\ref{eq:I})). The PI control algorithm requires a tuned proportional (P) term and a tuned integral (I) term. The tuning process is described in Section~\ref{sec:tune}. The general behaviour of P and I terms and their impact individually and combined are discussed in Section~\ref{sec:pi_behave} where it is seen that I term is necessary for prototype compensation. The impact of I term is significant on magnetic compensation compare to P term. It also reveals that I term is responsible for current unsettle problem in the coils. The previous studies does not help us understanding the current unsettle problem. We have added more fluxgates, change the positions of the fluxgates to understand the current unsettle problem which is discussed in Section~\ref{sec:flux_place}. Moreover, as the fluxgate placements study does not give us any clue we have removed the passive shield to see if that makes any difference but removing shield makes no difference . As our different studies are failing to discover the solution of slow current response we become motivate to build a simulation of the prototype. The simulation of the prototype integrating PI algorithm is discussed in Section~\ref{sec:pSim} where similarity between the experiment and simulation is shown. The PI simulation is another achievement for use. The simulation makes us generate new ideas to solve the current unsettle problem. As P and I term fail to solve the slow response problem, we change $r$ keeping P and I term fixed. The effect of changing $r$ is discussed in Section~\ref{sec:new_study_r} where it is discovered that lowering the value of $r$ can solve the slow current response but at the same time high frequency noise is induced. The author in Ref.~\cite{rawlik} introduces new ideas about the matrix should be well-conditioned before it takes part in the PI feedback loop which helps us look into matrix condition number in deep. While studying matrix condition number, we have realized that we can use the concept to find $r$ alternative to another method discussed in Section~\ref{sec:mont}. We propose new method of regularization where optimize $r$ is determined based on lowest matrix condition number the method is discussed in Section~\ref{sec:cond}. The author in Ref.~\cite{rawlik} also claims that for a perfectly conditioned matrix there is no need of PI algorithm which we prove wrong in Section~\ref{sec:style_pi}. While studying matrix condition number, we also realize that matrix is ill conditioned because one of of the current modes producing zero net current. We have improved the matrix condition number significantly which also eliminates our initial problem of current unsettle discussed in Section~\ref{sec:coil_config}.

\section{Directions for Future Students}

The simulation of the prototype active compensation system is vital to demonstrate a full understanding of the experimental results. We have made simulation which can produce $M_{sc}$ elements for any number of the sensors placed in the prototype geometry. This will be a tool for the future students who are limited by sensor position and placing them correctly in their system to study in detail about the effect of $\bm{M}$ for any set of sensors.Simulation of a certain system integrating feedback algorithm is a unique work that has not been still published in any thesis related to active compensation. 



\section{Implementation at TUCAN nEDM Experiment}
% \subsubsection{Effect of changing only P term}
% Here, the effect of changing proportional gain term (P) or $k_c^p$ of Eq.~(\ref{eq:I}) will be discussed.

% P term is proportionally multiplying the error (the difference between setpoint and actual measurement) with a constant gain. For the prototype it is

% \begin{equation}
%     P_{\text{PI}}=k_c^p \Delta I_c^n
% \end{equation}
% where, $k_c^p$ is the proportional gain and $\Delta I_c^n$ is explained in Eq.~(\ref{eq:del_I}).

% Depending on the value $k_c^p$, it tries to minimize the error level between the setpoint and the actual measurement with passage of several measurements. A large value of $k_c^p$ will result large output change for a particular error and eventually it reaches a threshold point above which the system becomes unstable. 

% % \begin{figure}[!htb]
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/p25}
% %         \caption{at $k_c^p$=0.25}
% %         \label{fig:p25}
% %     \end{subfigure}%
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/p50}
% %         \caption{at $k_c^p$=0.50}
% %         \label{fig:p50}
% %     \end{subfigure}\\[1ex]
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/p75}
% %         \caption{at $k_c^p$=0.75}
% %         \label{fig:p75}
% %     \end{subfigure}%
% %         \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/p100}
% %         \caption{at $k_c^p$=1.0}
% %         \label{fig:p100}
% %     \end{subfigure}

% %     \caption{Currents (left vertical axis) in all six coil sides ($C_x^\pm$, $C_y^\pm$ and $C_z^\pm$) with drift $\Delta$B (right vertical axis) at sensor position '1x' for different values of $k_c^p$ with $k_c^i$ in Eq.~(\ref{eq:I}) being zero. Blue color curve denotes the actual drift in signal at position '1x' found by Eq.~(\ref{eq:del_B}) while the red curve denotes the drift that would have been without the compensation. The 'ON' and 'OFF' vertical dashed lines indicate the time of the perturbation coil being turned 'ON' and 'OFF' respectively. For position of coils and sensors see Fig.~\ref{fig: coil}. }
% %     \label{fig:p_pi}
% % \end{figure}
% \begin{figure}[!htb]
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/p25_33}
%         \caption{at $k_c^p$=0.25}
%         \label{fig:p25}
%     \end{subfigure}%
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/p50_33}
%         \caption{at $k_c^p$=0.50}
%         \label{fig:p50}
%     \end{subfigure}\\[1ex]
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/p75_33}
%         \caption{at $k_c^p$=0.75}
%         \label{fig:p75}
%     \end{subfigure}%
%         \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/p100_33}
%         \caption{at $k_c^p$=1.0}
%         \label{fig:p100}
%     \end{subfigure}

%     \caption{Currents (left vertical axis) in all six coil sides ($C_x^\pm$, $C_y^\pm$ and $C_z^\pm$) with drift $\Delta$B (right vertical axis) at sensor position '1x' for different values of $k_c^p$ with $k_c^i$ in Eq.~(\ref{eq:I}) being zero. Blue color curve denotes the actual drift in signal at position '1x' found by Eq.~(\ref{eq:del_B}) while the red curve denotes the drift that would have been without the compensation. The 'ON' and 'OFF' vertical dashed lines indicate the time of the perturbation coil being turned 'ON' and 'OFF' respectively. For position of coils and sensors see Fig.~\ref{fig: coil}. }
%     \label{fig:p_pi}
% \end{figure}

% The effect of changing $k_c^p$ has been shown in Fig.~\ref{fig:p_pi} where the currents (left) that are being sent to the coils ($C_x^\pm$, $C_y^\pm$ and $C_z^\pm$) for drift $\Delta$B found by Eq.~(\ref{eq:del_B}) in sensor position '1x'.  It is seen that $\Delta$B=17.5 nT, 15.5 nT and 13.5 nT for $k_c^p$ = 0.25, 0.5 and 0.75 respectively (see Fig.~\ref{fig:p_pi}\textcolor{blue}{(a)}, Fig.~\ref{fig:p_pi}\textcolor{blue}{(b)}, Fig.~\ref{fig:p_pi}\textcolor{blue}{(c)}). That is, with the increase of $k_c^p$, $\Delta$B magnetic field decreases. But, it has a limit after which with the increase of $k_c^p$, the systems becomes unstable and starts oscillating which can be seen from Fig.~\ref{fig:p_pi}\textcolor{blue}{(d)}) where the currents (left) are oscillating and the drift itself also at $\Delta$B=12.5 nT (right). So, the error is reduced maximum by (20.5-12.5)/20.5 * 100$\%\approx$37$\%$ from the initial drift of $\Delta$B=20.5 nT denoted by the red curve at position '1x'. 

% \FloatBarrier
% The above results confirm that the difference between the setpoint and the actual measurements of the magnetic field can be reduced upto a certain point. So, only having the P term is no the solution for the prototype. Next, we will discuss about the effect of only I term.

% \subsubsection{Effect of changing only I term}
% Here, the effect of changing integral reset term (I) or $k_c^i$ of Eq.~(\ref{eq:I}) will be discussed.

% The error (the difference between setpoint and actual measurement) is accumulated for the length of measurements and I term is multiplying that accumulated error  with a constant gain. For the prototype it is

% \begin{equation}
%     I_{\text{PI}}=k_c^i \sum_n \Delta I_c^n
% \end{equation}
% where, $k_c^i$ is the integral gain and $\Delta I_c^n$ is explained in Eq.~(\ref{eq:del_I}).

% Accumulated error keep tracks of the offsets that should be corrected previously. I term takes care of the offset which are not corrected by the P term and thus accelerates reducing the error level. Depending on the value $k_c^i$, how fast the feedback loop will response to the drift in the signal will be determined. A large value of $k_c^p$ will result large faster response to reducing the error level and eventually it reaches a threshold point above which the actual measurement will overshoot i.e. exceed the setpoint. 
% % The main downfall of this is that the time required for the coil current to be settle in after reducing the error level may be very slow or never ever settle in.



% % As like the effect on P, the effect of changing I has been shown in Fig.~\ref{fig:i_pi} where the change in current in all six coil sides with  $\Delta$B on a particular sensor position have been observed for $k_c^i$=0.25, 0.5, 0.75 and 1.0 . It is seen that with increase of I the level of compensation of the magnetic field is almost similar but the main difference occurs on how fast the system response in an expense of increasing current in all the coil sides (see Fig.~\ref{fig:i_pi}\textcolor{blue}{(a)}, Fig.~\ref{fig:i_pi}\textcolor{blue}{(b)}, Fig.~\ref{fig:i_pi}\textcolor{blue}{(c)} and Fig.~\ref{fig:i_pi}\textcolor{blue}{(d)}). The main problem with changing only I term is that it creates a very slow current response time. But, in terms of compensation only changing I gives very good result. The slow current response can be minimized by decreasing the value of optimized 'r' (see Section \ref{sec:r_pi} and Section \ref{sec:r_currentResponse} ).

% % \begin{figure}[!htb]
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i25}
% %         \caption{at $k_c^i$=0.25}
% %         \label{fig:i25}
% %     \end{subfigure}%
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i50}
% %         \caption{at $k_c^i$=0.5}
% %         \label{fig:i50}
% %     \end{subfigure}\\[1ex]
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i75}
% %         \caption{at $k_c^i$=0.75}
% %         \label{fig:i75}
% %     \end{subfigure}%
% %         \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i100}
% %         \caption{at $k_c^i$=1.0}
% %         \label{fig:i100}
% %     \end{subfigure}

% %     \caption{Currents (left vertical axis) in all six coil sides ($C_x^\pm$, $C_y^\pm$ and $C_z^\pm$) with drift $\Delta$B (right vertical axis) at sensor position '1x' for different values of $k_c^i$ with $k_c^p$ ( see Eq.~(\ref{eq:I}) ) being zero. Blue color curve denotes the actual drift in signal at position '1x' found by Eq.~(\ref{eq:del_B}) while the red curve denotes the drift that would have been without the compensation. The 'ON' and 'OFF' vertical dashed lines indicate the time of the perturbation coil being turned 'ON' and 'OFF' respectively. For position of coils and sensors see Fig.~\ref{fig: coil}.}
% %     \label{fig:i_pi}
% % \end{figure}
% \begin{figure}[!htb]
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i25_33}
%         \caption{at $k_c^i$=0.25}
%         \label{fig:i25}
%     \end{subfigure}%
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i75_33}
%         \caption{at $k_c^i$=0.75}
%         \label{fig:i50}
%     \end{subfigure}\\[1ex]
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i100_33}
%         \caption{at $k_c^i$=1.0}
%         \label{fig:i75}
%     \end{subfigure}%
%         \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i125_33}
%         \caption{at $k_c^i$=1.25}
%         \label{fig:i100}
%     \end{subfigure}

%     \caption{Currents (left vertical axis) in all six coil sides ($C_x^\pm$, $C_y^\pm$ and $C_z^\pm$) with drift $\Delta$B (right vertical axis) at sensor position '1x' for different values of $k_c^i$ with $k_c^p$ ( see Eq.~(\ref{eq:I}) ) being zero. Blue color curve denotes the actual drift in signal at position '1x' found by Eq.~(\ref{eq:del_B}) while the red curve denotes the drift that would have been without the compensation. The 'ON' and 'OFF' vertical dashed lines indicate the time of the perturbation coil being turned 'ON' and 'OFF' respectively. For position of coils and sensors see Fig.~\ref{fig: coil}.}
%     \label{fig:i_pi}
% \end{figure}

% \FloatBarrier
% The effect of changing $k_c^i$ has been shown in Fig.~\ref{fig:i_pi} where the currents (left) that are being sent to the coils ($C_x^\pm$, $C_y^\pm$ and $C_z^\pm$) for drift $\Delta$B found by Eq.~(\ref{eq:del_B}) in sensor position '1x'.  It is seen from Fig.~\ref{fig:i_pi}\textcolor{blue}{(a)}, Fig.~\ref{fig:i_pi}\textcolor{blue}{(b)}, Fig.~\ref{fig:i_pi}\textcolor{blue}{(c)} and Fig.~\ref{fig:i_pi}\textcolor{blue}{(d)} which are correspond to $k_c^i$ = 0.25, 0.75, 1.0 and 1.25 respectively that the error level (right) is $\sim$3.5 nT in every case, the coil currents(left) never settle in any of them. The figures are neither helpful to understand the system response time nor the overshoot effect in the $\Delta$B graph (right). So for understating those effects, the $\Delta$B graphs (right) have been zoomed in and shown in Fig.~\ref{fig:i_pi_zoom}. Now it is easily seen that the system tries to keep the error level within $\sim$ 3 nT of the setpoint which is at 0 nT as a low as 6s for $k_c^i$=0.25, then 2.2 s for $k_c^i$=0.5, 1.5s for $k_c^i$=0.75 and as fast as 0.45s for $k_c^i$=1.0 in Fig.~\ref{fig:i_pi_zoom}\textcolor{blue}{(a)}, Fig.~\ref{fig:i_pi_zoom}\textcolor{blue}{(b)}, Fig.~\ref{fig:i_pi_zoom}\textcolor{blue}{(c)} and Fig.~\ref{fig:i_pi_zoom}\textcolor{blue}{(d)} respectively. It is also seen from the Fig.~\ref{fig:i_pi_zoom}\textcolor{blue}{(d)} that there is an overshoot in the error level before it settles in. That is the error level is exceeding the target which is $\sim$3 nT of the setpoint and then it settles in.

% \begin{figure}[!htb]
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i25_33_zoom.png}
%         \caption{at $k_c^i$=0.25}
%         \label{fig:i25zoom}
%     \end{subfigure}%
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i75_33_zoom.png}
%         \caption{at $k_c^i$=0.75}
%         \label{fig:i75zoom}
%     \end{subfigure}\\[1ex]
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i100_33_zoom.png}
%         \caption{at $k_c^i$=1.0}
%         \label{fig:i100zoom}
%     \end{subfigure}%
%         \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/i125_33_zoom.png}
%         \caption{at $k_c^i$=1.25}
%         \label{fig:i125zoom}
%     \end{subfigure}

%     \caption{Zoomed in version of the drift $\Delta$B shown in right side of Fig.~\ref{fig:i_pi}\textcolor{blue}{(a)}, Fig.~\ref{fig:i_pi}\textcolor{blue}{(b)}, Fig.~\ref{fig:i_pi}\textcolor{blue}{(c)} and Fig.~\ref{fig:i_pi}\textcolor{blue}{(d)} respectively at sensor position '1x' for different values of $k_c^i$ with $k_c^p$ ( see Eq.~(\ref{eq:I}) ) being zero. The red vertical dashed line indicates the time of the perturbation coil being turned 'ON'. For position of coils and sensors see Fig.~\ref{fig: coil}.\label{fig:i_pi_zoom}}
% \end{figure}

% % \fig{Images/i_pi_zoom}{width = \textwidth,height =10cm}{Zoomed in version of the drift $\Delta$B shown in right side of Fig.~\ref{fig:i_pi}\textcolor{blue}{(a)}, Fig.~\ref{fig:i_pi}\textcolor{blue}{(b)}, Fig.~\ref{fig:i_pi}\textcolor{blue}{(c)} and Fig.~\ref{fig:i_pi}\textcolor{blue}{(d)} respectively at sensor position '1x' for different values of $k_c^i$ with $k_c^p$ ( see Eq.~(\ref{eq:I}) ) being zero. The red vertical dashed line indicates the time of the perturbation coil being turned 'ON'. For position of coils and sensors see Fig.~\ref{fig: coil}.\label{fig:i_pi_zoom}}


% \FloatBarrier
% The above results confirm that to get rid of the offsets that could not be reduce by the P term, an I term is a must. But using I term shows that the currents in the coils never settles in. Next the effect of applying both of them after tuning (see Section~\ref{sec:tune}) will be discussed and may be the currents settle there!!
% % \subsection{r vs. Condition No.}\label{sec:cond}
% % Instead of going through all the steps that are discussed in section \ref{sec:inv}, the concept of condition number of a matrix can be used. The condition number of $\bm{M}$ can be determined from the diagonal matrix $\bm{\Sigma}$ as given in eq.\ref{eq:m} by -
% %  \begin{equation}
% %      cond(\bm{M})=\frac{max(\sigma_d)}{min(\sigma_d)}
% %  \end{equation}
 

% \subsubsection{Effect of changing PI term Combinely}
% Finally, the Section~\ref{sec:pi_behave} will be ended here with the discussion of the effect of changing P and I term at a time which will complete the Eq.~(\ref{eq:I}).

% Here, first the P and I term have been tuned following the discussion on Section~\ref{sec:tune} which has generated $k_c^p$=0.43 and $k_c^i$=0.52 . The results by applying $k_c^p$ and $k_c^i$ as those tuned values are shown in Fig.~\ref{fig:tuned_vs_i}\textcolor{blue}{(a)}. For simplicity instead of showing all the drift $\Delta$B for all the fluxgate sensors for the positions given in the horizonatal axis of Fig.~\ref{fig:m}, only '1x' is shown on the right of the figure. And same as earlier the currents  that are being sent to the coils ($C_x^\pm$, $C_y^\pm$ and $C_z^\pm$) shown on the left of the same figure. But, we couldn't determine the effect of having both of them at a time. So, keeping $k_c^i$ as 0.52 and excluding P term i.e. $k_c^p$=0.0 we run the same measurement again and the results are shwon in Fig.~\ref{fig:tuned_vs_i}\textcolor{blue}{(b)}. As as matter of surprise, there is hardly any difference between the results in Fig.~\ref{fig:tuned_vs_i}\textcolor{blue}{(a)} and Fig.~\ref{fig:tuned_vs_i}\textcolor{blue}{(b)}. Why is that so ? For the moment, the Fig.~\ref{fig:tuned_vs_i} suggests that may be we don't need P term at all or maybe we need different tuning methods. So, applying P and I term at a time doesn't solve our original problem of unsettle current, rather it raises another question of the necessity of the P term or importance of the tuning method describe in Section~\ref{sec:tune}. Due to lack of time, we did not further go into other tuning methods. Rather we have tried to correct our original problem of unsettle current and also discover the differences in the work between Ref.~\cite{bea} and Ref.~\cite{rawlik}.
% \doublefig{Images/p43i52_33}{width =\textwidth,height =8cm}{at $k_c^p$=0.43 and $k_c^i$=0.52. \label{fig:pi_tuned}}{Images/i52_33}{width = \textwidth,height =8cm}{at $k_c^p$=0.0 and $k_c^i$=0.52..\label{fig:i52}}{{Currents (left vertical axis) in all six coil sides ($C_x^\pm$, $C_y^\pm$ and $C_z^\pm$) with drift $\Delta$B (right vertical axis) at sensor position '1x' for combine different values of $k_c^i$ and $k_c^p$ ( see Eq.~(\ref{eq:I}) ). Blue color curve denotes the actual drift in signal at position '1x' found by Eq.~(\ref{eq:del_B}), while the red curve denotes the drift that would have been without the compensation. The 'ON' and 'OFF' vertical dashed lines indicate the time of the perturbation coil being turned 'ON' and 'OFF' respectively. For position of coils and fluxgate sensor see Fig.~\ref{fig: coil}.} \label{fig:tuned_vs_i}}

% \FloatBarrier
% The above results rather clearing our original acquisition of unsttle coil currents, give us more confusion on the effectiveness of the P term and also the tuning method. Instead of loooking more deep into tuning method, we moved our focused into regularization parameter to settle coil currents that will be presented in upcoming Section.


% \section{New Studies on Regularization Parameter}\label{sec:new_study_r}
% In Section~\ref{sec:inv} we have introduced the regularization parameter 'r' and then discussed a simulation model in Section~\ref{sec:mont} which later has been justified by comparing with experimental setup in Section~\ref{fig:mont_comp}. We have also talked about the tuning method in Section~\ref{sec:tune} and later in Section~\ref{sec:pi_behave} we have shown the the effect of the P and I term and a lot of questions arises there. Here, we will propose a new method to find 'r' based on condition number of matrix and finally we will will wrap up the Section with further tuning of optimized 'r' which will try to solve the current unsettle problems discussed in the earlier Section and 

% So, first new method to find 'r' will be discussed.

% \subsection{Regularization by Matrix Condition Number Method  }\label{sec:cond}
% Matrix Condition number ( see Eq.~(\ref{eq:cond} ) and regularization parameter 'r' ( see Eq.~(\ref{eq:minvR} ) have been introduced in Section.~\ref{sec:m} while discussing the inversion of the matrix $\bm{M}$ . Moreover, in Section~\ref{sec:mont}, a method of regularization by random fluctuation has been discussed. Here, we will propose another method of regularization using the concept of matrix condition number.
 
%  Recall from Section~\ref{sec:inv}, regularization is needed in the first place while inverse of the matrix $\bm{M}$ because $\bm{M}$ itself is ill-conditioned matrix. That means the $\bm{M}$ has a large condition number which while inverse would produce large currents in some ill-positioned places that will make the system unstable. So, it is required to have a well-conditioned  $\bm{M^{-1}}$ which implies that the condition number of $\bm{M^{-1}}$ should be small and that's what regularization has been doing. So, we introduce Eq.~\ref{eq:minvR} with various values of 'r' and each time the condition number of $\bm{M^{-1}}$ is stored. Then the optimized 'r'  has been determined by selecting the 'r' for which the condition number of $\bm{M^{-1}}$ is the minimum.
 
%  The condition number of $\bm{M^{-1}}$ for different values of 'r' has been shown in Fig.~\ref{fig:cond}. It is seen that for 'r'=0, the condition number of $\bm{M^{-1}}$=$\sim$40 that is same as the condition number of $\bm{M}$ itself. So, without regularization that is the condition number of pseudo-inverse of $\bm{M}$ would also give =$\sim$40. In regularization method, several 'r' is tried ( see Eq.~(\ref{eq:minvR}) ) and each time the condition number has been stored which are shown in the vertical axis. The red diamond symbol indicates that for 'r'=2.94, the condition number of $\bm{M^{-1}}$ is minimum and that is 3.1. That by using 'r'=2.94 in Eq.~(\ref{eq:minvR}), the condition number decrease from 40 to 3.1 which is 40/3.1$\approx$13 times of decrements. The Fig.\ref{fig:I-fluc} shows that the 'r'=2.87 compared to 'r'=2.94 that we found here. So, both method shows comparable result. This method will always produce fixed optimized 'r' for a particular  $\bm{M}$ but the method by random fluctuation (see Section~\ref{sec:mont}) will produce different optimize 'r' for different run as it because depends on the random field.

 
% \fig{Images/6c_Mcond}{width = \textwidth,height =10cm}{Condition Number of $\bm{M^{-1}}$ (vertical axis) for different values of 'r. The matrix is same as described by the Fig.~\ref{fig:m}.  \label{fig:cond}}

% \FloatBarrier

% In the above, different method to find optimize 'r' has been discussed which is a good alternative to the one explained in Section~\ref{sec:mont} and the results are similar. But it doesn't also solve the current unsettle problem discussed in Section~\ref{sec:pi_behave}. So, in the next tried again the several values of 'r' to see its effect on current unsettle problem. 


% % \subsubsection{Optimized r  Revisited Based on Current Response Time}\label{sec:r_currentResponse}
% % It was found that there is very slow coil current rise time while applying perturbation. To get rid of that problem, first and foremost, the fastest sampling frequency (see section [\ref{sec:filter}, \ref{sec:freq}]) is needed. Then, the next step of the problem can be solved via two ways with individual having own limitations. First way is tuning the value of P and I term of PI loop as explained in Eq.~(\ref{eq:I} and section \ref{sec:tune}. But with increasing the value of P, the current start oscillating after certain values as shown by the top and middle current graph on Fig.~\ref{fig:crnt} which is a problem. 

% % \fig{Images/crnt}{width = \textwidth}{Coil current in one of the coil side for optimized r=2.8 with P=0 and I=1.0 (top) and with P=0 and I=1.5 (middle) and for best r considering noise with P=0 and I=1.0 (bottom). \label{fig:crnt}}



% % The alternative way is to change the value of optimized r (see section [\ref{sec:mont}, \ref{sec:cond}]) which in turns increase noise in the prototype. But with inclusion of some current fluctuations, it was found that the coil current response time was increased heavily  as shown by the bottom current graph in Fig.~\ref{fig:crnt}. Now, the best compromised value of r was chosen by observing the 'rise time vs r' and 'fluctuations vs r' as shown in Fig.~\ref{fig:riseT}.



% %  \doublefig{Images/riseT}{width =\textwidth, height= 8 cm}{Rise Time vs r \label{fig:rise}}{Images/fluc}{width = \textwidth, height= 8 cm}{Fluctuations\label{fig:fluc}}{{(a) shows the Rise Time vs r (b) shows the Fluctuations } \label{fig:riseT}}
% % % \fig{Images/bt}{width = \textwidth}{Magnetic Field Compensation \label{fig:bt}}
% \subsection{r Behavior on PI Tuning}\label{sec:r_pi}
% % \begin{figure}[!htb]
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 5 cm]{Images/r16}
% %         \caption{at r=1.6}
% %         \label{fig:r16}
% %     \end{subfigure}%
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 5 cm]{Images/r18}
% %         \caption{at r=1.8}
% %         \label{fig:r18}
% %     \end{subfigure}\\[1ex]
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 5 cm]{Images/r20}
% %         \caption{at r=2.0}
% %         \label{fig:fExp}
% %     \end{subfigure}%
% %         \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 5 cm]{Images/r22}
% %         \caption{at r=2.2}
% %         \label{fig:r22}
% %     \end{subfigure}\\[1ex]
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 5 cm]{Images/r24}
% %         \caption{at r=2.4}
% %         \label{fig:r24}
% %     \end{subfigure}%
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 5 cm]{Images/r26}
% %         \caption{at r=2.6}
% %         \label{fig:r26}
% %     \end{subfigure}\\[1ex]
% %     \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 5 cm]{Images/r28}
% %         \caption{at r=2.8}
% %         \label{fig:r28}
% %     \end{subfigure}%
% %         \begin{subfigure}{.5\linewidth}
% %         \centering
% %         \includegraphics[width=\linewidth, height= 5 cm]{Images/r30}
% %         \caption{at r=23.0}
% %         \label{fig:r30}
% %     \end{subfigure}


% %     \caption{Change in the current in all six coil sides with obtained $\Delta$B on a particular sensor position. Here, the value of I=0.25,0.5,0.75 and 1.00 with P term being zero.}
% %     \label{fig:r_pi}
% % \end{figure}
% The discussion on Section \ref{sec:pi_behave} suggests that I term is necessary for fast system response due to any drift in the magnetic signal as it takes care of the offset problems which is unsolvable by using only P term. But, in doing so, it also creates problems in terms of the coil currents which never settle in for the duration of the perturbation. The tuning method described in Section~\ref{sec:tune} should have take care of this but we have realized that having tuned P and I has similar effect like having only I term. So, tuning method doesn't give us the solution. Rather looking for different tuning method , we have focused on the effect of 'r' on PI tuning. This Section will discuss that effect with possible outcome.

% The experimental setup is same as discussed in Section~\ref{sec:pi_behave}. But in this case we have chosen $k_c^p$=0 and $k_c^i$=0.52. Among those $k_c^i$=0.52 has been found due to PI tuning (see Section~\ref{sec:tune}) and instead of choosing  $k_c^p$=0.43 we have made this zero as from the earlier discussion we saw that it barely has any effect while we use the I term. So, these values of $k_c^p$ and $k_c^i$ will be applied on Eq.~\ref{eq:I} to find the currents to be sent to the coils ($C_x^\pm$, $C_y^\pm$ and $C_z^\pm$) for drift $\Delta$B found by Eq.~(\ref{eq:del_B}) in the sensor positions given in the horizontal axis of Fig.~\ref{fig:m}. So, keeping those fixed, we will try to change the value of 'r' which will modify the Eq.~(\ref{eq:minvR}) for each change of 'r' value.

% The effect of changing 'r' with $k_c^p$=0 and $k_c^i$=0.52 has been shown in Fig.~\ref{fig:r_pi} where the currents (left) that are being sent to the coils ($C_x^\pm$, $C_y^\pm$ and $C_z^\pm$) for drift $\Delta$B found by Eq.~(\ref{eq:del_B}) in sensor position '1x'.  It is seen from Fig.~\ref{fig:r_pi}\textcolor{blue}{(a)}, Fig.~\ref{fig:r_pi}\textcolor{blue}{(b)}, Fig.~\ref{fig:r_pi}\textcolor{blue}{(c)} and Fig.~\ref{fig:r_pi}\textcolor{blue}{(d)} which are correspond to 'r' = 2.0, 2.4, 2.8 and 3.2 respectively that the changing 'r' has significant effect on the coil current graph and barely any effect on the system response time for reducing the drift in the signal. That is at 'r'=2.0, the coil current graph has the fastest settling time where the current settles within 3 s after the perturbation has been applied. At 'r'=2.4, it takes 10s for the coil currents to settle in. But at 'r'=2.8, it seems like the coil current never settles in which is again improved at 'r'=3.2. Note that the here seroiusly ill conditioned matrix has been usedoptimized 'r' found by the simulation model is $\sim$2.9 which tells us that the coil settling of the current graph seems to have issue with the that optimized 'r. So, instead of taking the optimized 'r' that has been found by the simulation model we may have to choose the lower value of 'r'. Then question arises about what if 'r' value is chosen more than the optimized 'r'. For answering that question, we have also studied the effect for more values of 'r' with same setup which are shown in Fig.~\ref{fig:r_pi_more}. It is seen from Fig.~\ref{fig:r_pi_more}\textcolor{blue}{(a)}, Fig.~\ref{fig:r_pi_more}\textcolor{blue}{(b)}, Fig.~\ref{fig:r_pi_more}\textcolor{blue}{(c)} and Fig.~\ref{fig:r_pi_more}\textcolor{blue}{(d)} which are correspond to 'r' = 3.5, 3.6, 3.7 and 3.9 respectively that the coil current graph seems to be settle in for larger value of 'r' before it starts showing less responsive for example at 'r'=3.9 .   





% with the increase of 'r' although the error level (right) is $\sim$3 nT in every case, the coil currents(left) never settle in any of them. The figures are neither helpful to understand the system response time nor the overshoot effect in the $\Delta$B graph (right). So for understating those effects, the $\Delta$B graphs (right) have been zoomed in and shown in Fig.~\ref{fig:i_pi_zoom}. Now it is easily seen that the system tries to keep the error level within $\sim$ 3 nT of the setpoint which is at 0 nT as a low as 6s for $k_c^i$=0.25, then 2.2 s for $k_c^i$=0.5, 1.5s for $k_c^i$=0.75 and as fast as 0.45s for $k_c^i$=1.0 in Fig.~\ref{fig:i_pi_zoom}\textcolor{blue}{(a)}, Fig.~\ref{fig:i_pi_zoom}\textcolor{blue}{(b)}, Fig.~\ref{fig:i_pi_zoom}\textcolor{blue}{(c)} and Fig.~\ref{fig:i_pi_zoom}\textcolor{blue}{(d)} respectively. It is also seen from the Fig.~\ref{fig:i_pi_zoom}\textcolor{blue}{(d)} that there is an overshoot in the error level before it settles in. That is the error level is exceeding the target which is $\sim$3 nT of the setpoint and then it settles in.


% and fast response and that also causes the current in the coil sides being higher with very slow current response time. To minimize that in addition to normal tuning of PI, the effect of 'r' on PI tuning has been also studied as shown in Fig.~\ref{fig:r_pi} where the change in current in all six coil sides with  $\Delta$B on a particular sensor position have been observed for P=0.45, I=0.27 and r=1.8, 2.2, 2.6 and 3.0. It is seen that with increase of 'r' having same P and I term, the response on the current decreases (see Fig.~\ref{fig:r20}, Fig.~\ref{fig:r24}, Fig.~\ref{fig:r28} and Fig.~\ref{fig:r32}). So, the tuned system can be more tuned up by changing 'r' (more on Section \ref{sec:r_pi}). This is an unique finding as it suggests to alternative option of tuning.

% \begin{figure}[!htb]
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/r20}
%         \caption{at r=2.0}
%         \label{fig:r20}
%     \end{subfigure}%
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/r24}
%         \caption{at r=2.4}
%         \label{fig:r24}
%     \end{subfigure}\\[1ex]
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/r28}
%         \caption{at r=2.8}
%         \label{fig:r28}
%     \end{subfigure}%
%         \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/r32}
%         \caption{at r=3.2}
%         \label{fig:r32}
%     \end{subfigure}


%     \caption{Change in the current in all six coil sides with obtained $\Delta$B on a particular sensor position with red represents uncompensated $\Delta$B. Here, the value of P=0.45, I=0.27 and r=1.8, 2.2, 2.6 and 3.0}
%     \label{fig:r_pi}
% \end{figure}
% \FloatBarrier

% \begin{figure}[!htb]
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/r35}
%         \caption{at r=3.5}
%         \label{fig:r35}
%     \end{subfigure}%
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/r36}
%         \caption{at r=3.6}
%         \label{fig:r36}
%     \end{subfigure}\\[1ex]
%     \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/r37}
%         \caption{at r=3.7}
%         \label{fig:r37}
%     \end{subfigure}%
%         \begin{subfigure}{.5\linewidth}
%         \centering
%         \includegraphics[width=\linewidth, height= 6.5 cm]{Images/r39}
%         \caption{at r=3.9}
%         \label{fig:r39}
%     \end{subfigure}


%     \caption{Change in the current in all six coil sides with obtained $\Delta$B on a particular sensor position with red represents uncompensated $\Delta$B. Here, the value of P=0.45, I=0.27 and r=1.8, 2.2, 2.6 and 3.0}
%     \label{fig:r_pi_more}
% \end{figure}
% \FloatBarrier